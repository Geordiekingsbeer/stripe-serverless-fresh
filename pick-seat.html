<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Reserve Your Table</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<style>
		/* ... (Existing CSS omitted for brevity) ... */
		body{
			font-family: Arial, Helvetica, sans-serif;
			text-align: center;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: flex-start;
			padding: 20px 10px;
			background: #e3e3e3;
			min-height: 100vh;
		}
		
		h1 {
			font-size: 32px;
			font-weight: 700;
			color: #333;
			margin-bottom: 5px;
		}

		.subtitle {
			font-size: 18px;
			color: #666;
			margin-bottom: 30px;
		}

		.instructions {
			display: none;
		}

		#datetime-controls {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
			align-items: center;
			padding: 0;
			background: none;
			box-shadow: none;
			flex-wrap: nowrap;
			max-width: 480px;
			width: 100%;
		}

		#datetime-controls label {
			display: none;
		}
		
		#datetime-controls input {
			flex-grow: 1;
			padding: 12px 10px;
			border: 1px solid #ccc;
			border-radius: 4px;
			background-color: white;	
			font-size: 16px;
			color: #333;
			max-width: none;
			font-weight: 500;
			text-align: center;
			
			padding-left: 10px;	
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
			font-family: Arial, sans-serif;
		}
		
		#booking-date {
			 text-align: left;
			 padding-right: 5px;
		}

		#booking-time {
			 text-align: left;
			 padding-right: 5px;
		}


		#check-availability {
			padding: 12px 10px;
			background-color: #b7d7a8;
			color: #333;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: 600;
			flex-grow: 1;
			box-shadow: none;
			white-space: nowrap;
		}
		
		#check-availability:hover {
			background-color: #a7c598;
		}
		
		#multi-select-toggle {
			padding: 10px 15px;
			font-size: 16px;
			font-weight: 500;
			margin-bottom: 20px;
			border-radius: 4px;
			cursor: pointer;
			border: 1px solid #ccc;
			background-color: #f7f7f7;	
			color: #333;
			transition: all 0.2s ease;
			white-space: nowrap;
			width: 90vw;
			max-width: 480px;
			text-align: center;
			box-shadow: 0 1px 3px rgba(0,0,0,0.05);
		}
		
		#multi-select-toggle.active {
			background-color: #1976d2;
			color: white;
			border: 1px solid #1977d2;
		}

		#container-wrapper {
			display: flex;
			justify-content: center;
			width: 100%;
			max-width: 480px;	
		}

		#container{
			width: 100%;
			height: auto;
			border: none;	
			box-shadow: none;
			background-color: transparent;
		}

		.status-legend {
			margin-top: 10px;
			font-size: 14px;
			color: #555;
			display: flex;
			gap: 15px;
			flex-wrap: wrap;
			justify-content: center;
			max-width: 480px;
			width: 100%;
		}
		.legend-item {
			display: flex;
			align-items: center;
		}
		.legend-color {
			width: 15px;
			height: 15px;
			border-radius: 3px;
			margin-right: 5px;
			border: 1px solid #000;
		}

		/* --- Shared Green Button Style (Base) --- */
		.green-action-btn{
			margin-top:20px;
			padding:12px 15px;
			font-size:16px;
			background:#388e3c; /* Base Dark Green */
			color:#fff;
			border:none;
			border-radius: 20px;
			cursor:pointer;
			box-shadow: 0 4px 6px rgba(0,0,0,0.1);
			/* These width properties apply to the main page button */
			width: 90vw;
			max-width: 480px;
			text-align: center;
			transition: background-color 0.2s ease;
			font-weight: 600;
			box-sizing: border-box;
		}
		
		.green-action-btn:hover:not(:disabled) {
			background: #2e7d32; /* Slightly darker green on hover */
		}
		
		.green-action-btn:disabled{
			background:#bbb;
			cursor: not-allowed;
			box-shadow: none;
		}
		/* --- END: Shared Green Button Style --- */

		/* Apply the new shared style to payBtn */
		#payBtn {
			width: 90vw;	
			max-width: 480px;
			margin-top: 20px;
		}

		.modal {
			display: none;	
			position: fixed;	
			z-index: 1001;	
			left: 0;
			top: 0;
			width: 100%;	
			height: 100%;	
			overflow: auto;	
			background-color: rgba(0,0,0,0.4);	
			justify-content: center;
			align-items: center;
		}

		.modal-content {
	position: relative;	 	 
	background-color: #fefefe;
	padding: 30px;
	border: 1px solid #888;
	width: 90%;
	max-width: 400px;
	border-radius: 10px;
	box-shadow: 0 5px 15px rgba(0,0,0,0.3);
	margin: 10vh auto;
}

/* Close (X) button in top-right of modal */
.close-modal {
	position: absolute;	 	 
	top: 10px; 	 	 	 	 	 
	right: 15px; 	 	 	 	 	 
	font-size: 24px;
	font-weight: 700;
	color: #888;
	cursor: pointer;
	line-height: 1;
	user-select: none;
	border: none;
	background: transparent;
	padding: 4px;
	border-radius: 4px;
	transition: color 0.12s ease, background-color 0.12s ease;
}

/* Hover/Focus states to make it obvious and accessible */
.close-modal:hover,
.close-modal:focus {
	color: #000;
	outline: none;
	background-color: rgba(0,0,0,0.04);
}
		
		/* Modal Content Inputs */
		.modal-content input {
			width: 100%;
			padding: 10px;
			margin-bottom: 15px;
			border: 1px solid #ccc;
			border-radius: 5px;
			box-sizing: border-box;
		}
		#tos-checkbox-group {
	display: flex;
	align-items: flex-start; 
	padding-top: 10px; 
	margin-bottom: 10px; 
	line-height: 1.25; 
}

/* Style the checkbox input itself */
#terms-of-service {
	width: auto !important;
	margin-right: 10px !important;
	margin-top: 2px; 
	position: static;	
}

/* General label style fix: Use Flexbox alignment for consistent spacing */
.optin-group {
	display: flex;
	align-items: flex-start; 
	margin-bottom: 25px;	
	text-align: left;
	padding-top: 10px;	
}

/* Ensure the input box inside optin-group aligns correctly */
.optin-group input[type="checkbox"] {
	margin-top: 2px; 
}
		/* Adjust confirm-booking-btn (Proceed to Payment) for full width in the modal */
		#confirm-booking-btn {
			padding: 12px 15px;
			border-radius: 20px;
			width: 100%;	
			max-width: 100%;
			margin-top: 20px;
			display: block;
		}
			
		/* New Modal for Party Size Prompt */
		#party-prompt-modal .modal-content {
	margin: 30vh auto;
	text-align: left;
	}
			
		/* The #set-party-size button also needs its own width/centering to correctly inherit green-action-btn's size behavior within the modal */
#set-party-size {
	width: auto; 
	display: block; 
	margin: 15px auto 0 auto; 
	min-width: 180px; 
	max-width: 100%; 
}
	</style>
    
    <script>
        // Get the tenant ID from the URL or set a fallback (R-RESTO-001)
        const urlParams = new URLSearchParams(window.location.search);
        const TENANT_ID = urlParams.get('tenant_id') || 'R-RESTO-001'; 

        // Dynamically load the client's configuration file from the root
        const configScript = document.createElement('script');
        // Looks for a file in the root: /[TENANT-ID].js (e.g., /R-RESTO-001.js)
        configScript.src = `/${TENANT_ID}.js`; 
        document.head.appendChild(configScript);
        
        // --- NOTE: CLIENT_TABLES will be defined globally by the external script ---
    </script>

</head>
<body>
	<h1 class="header-title" style="font-size: 24px;">Reserve Your Premium Table</h1>
        <p style="color: #b93d00; margin-bottom: 20px; max-width: 480px; text-align: center;">
    </p>

    <div id="datetime-controls" style="display: none;">
            </div>

	<button id="multi-select-toggle" data-active="false">Start Multi-Select Mode</button>

	<div id="container-wrapper">	
		<div id="container"></div>
	</div>

	<div class="status-legend">
		<div class="legend-item"><span class="legend-color" style="background-color: #b7d7a8;"></span>Premium Available</div>
		<div class="legend-item"><span class="legend-color" style="background-color: #e0e0e0;"></span>Booked (Premium)</div>
		<div class="legend-item"><span class="legend-color" style="background-color: #ffffff;"></span>Staff Use Only (N/A)</div>	
	</div>
	
	<button id="payBtn" class="green-action-btn" disabled>Pay for 0 Tables – Stripe</button>

	<div id="customer-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" id="close-customer-modal">&times;</span>
        <h3>Confirm Reservation Details</h3>
			<form id="customer-form">
				<input type="text" id="customer-name" placeholder="Full Name" required>
				<input type="number" id="party-size-hidden" placeholder="Party Size (e.g., 4)" min="1" required>
				<input type="email" id="customer-email" placeholder="Email for Receipt" required>
				<div class="optin-group" id="tos-checkbox-group">
    <input type="checkbox" id="terms-of-service" required>
    <label for="terms-of-service" style="font-weight: 500;">
        I agree to the Terms of Service and acknowledge the Strict Liability Limit on refunds which can be read 
        <a href="https://dine-select.com" target="_blank" style="color: #1976d2; text-decoration: underline;">here</a>.
    </label>
</div>

                <div class="optin-group">
                    <input type="checkbox" id="future-offers-optin">
                    <label for="future-offers-optin">
                        Yes, I would like to receive future offers and discounts from restaurants in my area.
                    </label>
                </div>

                <div class="non-refundable-warning">
                    PLEASE NOTE: This is a non-refundable purchase to secure your premium table.
                </div>
                <button type="submit" id="confirm-booking-btn" class="green-action-btn">Proceed to Payment</button>
			</form>
		</div>
	</div>
    
	<div id="party-prompt-modal" class="modal" style="display: none;">
		<div class="modal-content">
			<h3>How many people are in your party?</h3>
            <p style="margin-bottom: 20px;">Please enter your party size to view suitable tables.</p>
			<input type="number" id="initial-party-size" placeholder="1 to 6+" min="1" required>
			<button id="set-party-size" class="green-action-btn">Continue to Seating Map</button>
		</div>
	</div>

	<script src="https://js.stripe.com/v3/ "></script>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2 "></script>
	<script src="https://unpkg.com/konva@9/konva.min.js "></script>
	<script>
	
	const STAGE_WIDTH = 480;	
	const STAGE_HEIGHT = 480;	

	const supabaseUrl = 'https://Rrjvdabtqzkaomjuiref.supabase.co ';
	const supabaseAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyanZkYWJ0cXprYW9tanVpcmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDM3MzQsImV4cCI6MjA3NDcxOTczNH0.wAEeowZ8Yc8K54jAxEbY-8-mM0OGciMmyz6fJb9Z1Qg';
	const _supa = supabase.createClient(supabaseUrl, supabaseAnon);

	const container = document.getElementById('container');

	const stage = new Konva.Stage({ container: 'container', width: STAGE_WIDTH, height: STAGE_HEIGHT });
	const backgroundLayer = new Konva.Layer();
	stage.add(backgroundLayer);
	const layer = new Konva.Layer();
	stage.add(layer);
	
	const payBtn = document.getElementById('payBtn');
	const customerModal = document.getElementById('customer-modal');
	const customerForm = document.getElementById('customer-form');
	const multiSelectToggle = document.getElementById('multi-select-toggle');	

	let selectedTableIds = [];	
	let currentBookings = [];	
	let tableDataMap = new Map();	
	let isMultiSelectMode = false;	
    let selectedGroup = null;	
    let selectedMultiTables = new Set();	
    const MULTI_BOOK_BUTTON = { style: { display: 'none' } };
    	
    let CURRENT_PARTY_SIZE = 0;
    const FILTERED_COLOR = '#cccccc';

    function generateUniqueId() {
        return 'AUTO-' + Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    let URL_PARAMS = {
        tenant_id: null, 
        booking_ref: null,
        source: null,
        booking_date: null,
        booking_time: null
    };

	const PRICE_2_SEATER = 499;	
	const PRICE_4_SEATER = 999;	
	const PRICE_6_SEATER = 1499;

	const TABLE_COLOR = '#b7d7a8';		
	const BOOKED_COLOR = '#e0e0e0';		
	const UNAVAILABLE_COLOR = '#ffffff';
	const SEAT_COLOR = '#555';	
	const HIGHLIGHT_COLOR = '#ffeb3b';
	
	const STAFF_USE_TABLE_IDS = [10, 13, 12, 14, 1];
	
    function getTableCapacity(w, h) {
        if (w === 30 && h === 30) return 2;
        if ((w === 30 && h === 50) || (w === 50 && h === 30)) return 4;
        if (w === 90 && h === 30) return 6;
        return 0;
    }
	
    function getUrlParams() {
        // Use the global TENANT_ID set in the <head> script
        URL_PARAMS.tenant_id = TENANT_ID; 

        const urlParams = new URLSearchParams(window.location.search);
        
        URL_PARAMS.booking_ref = urlParams.get('booking_ref');
        URL_PARAMS.source = urlParams.get('source');
        
        // CRITICAL FIX: Auto-detect date/time/party size from email link variables
        URL_PARAMS.booking_date = urlParams.get('booking_date');
        URL_PARAMS.booking_time = urlParams.get('booking_time');
        const partySizeParam = urlParams.get('party_size');

        if (partySizeParam) {
            let size = parseInt(partySizeParam);
            if (!isNaN(size) && size >= 1) {
                CURRENT_PARTY_SIZE = size;
            }
        }
        
        if (!URL_PARAMS.booking_ref) {
             URL_PARAMS.booking_ref = generateUniqueId();
        }
    }
	
    function getSelectedTablesCapacity() {
        let maxCapacity = 0;
        selectedTableIds.forEach(id => {
            const data = tableDataMap.get(id);
            if (data) {
                maxCapacity += getTableCapacity(data.w, data.h);
            }
        });
        return maxCapacity;
    }

    function isWastedCapacity(tableCapacity) {
        if (CURRENT_PARTY_SIZE === 0) return false;
        if (CURRENT_PARTY_SIZE <= 2 && tableCapacity > 2) return true;	
        if (CURRENT_PARTY_SIZE <= 4 && tableCapacity === 6) return true;
        return false;
    }

    function isTooSmall(tableCapacity) {
        if (CURRENT_PARTY_SIZE === 0) return false;
        if (CURRENT_PARTY_SIZE > 2 && tableCapacity === 2) return true;
        if (CURRENT_PARTY_SIZE > 4 && tableCapacity === 4) return true;
        return false;
    }

	async function logInitialClick() {
		if (!URL_PARAMS.booking_ref) {
			return;
		}
		
        // Supabase tracking logic...
	}


	function timeToMinutes(timeStr) {
		const parts = timeStr.split(':').map(Number);
		const hours = parts[0] || 0;
		const minutes = parts[1] || 0;
		return (hours * 60) + minutes;
	}
	
	function getTablePrice(w, h) {
		if (w === 30 && h === 30) return PRICE_2_SEATER;
		if ((w === 30 && h === 50) || (w === 50 && h === 30)) return PRICE_4_SEATER;
		if (w === 90 && h === 30) return PRICE_6_SEATER;
		return 0;
	}

	function calculateTotalPence() {
		let totalPence = 0;
		selectedTableIds.forEach(id => {
			const data = tableDataMap.get(id);
			if (data) {
				totalPence += data.price;
			}
		});
		return totalPence;
	}

	function updatePayButton(totalPence) {
		const totalDollars = (totalPence / 100).toFixed(2);
		if (totalPence > 0) {
			payBtn.disabled = false;
			payBtn.textContent = `Pay £${totalDollars} – Stripe`;
		} else {
			payBtn.disabled = true;
			payBtn.textContent = `Pay for 0 Tables – Stripe`;
		}
	}

	function resizeStage() {
		const containerWidth = container.offsetWidth;
		const scale = containerWidth / STAGE_WIDTH;

		stage.width(containerWidth);
		stage.height(STAGE_HEIGHT * scale);
		stage.scale({ x: scale, y: scale });

		container.style.height = `${STAGE_HEIGHT * scale}px`;

		stage.draw();
	}
	
	function loadFloorplan(callback) {
		const imageObj = new Image();
		imageObj.onload = function() {
			const floorplan = new Konva.Image({
				x: 0, y: 0, image: imageObj, width: STAGE_WIDTH, height: STAGE_HEIGHT,
			});
			backgroundLayer.add(floorplan);
			
			backgroundLayer.draw();
			
			resizeStage();	
			
			if (callback) callback();
		};
		imageObj.src = `/${URL_PARAMS.tenant_id}.png?v=` + new Date().getTime();	
	}

	async function loadBookings() {
		if (!URL_PARAMS.tenant_id || !URL_PARAMS.booking_date || !URL_PARAMS.booking_time) {
			console.error("Error: Missing mandatory booking details in URL.");
			document.getElementById('party-prompt-modal').style.display = 'flex';	
			currentBookings = [];
			updateTableVisuals();
			return false;
		}

		// ... (rest of loadBookings logic remains the same) ...

		updateTableVisuals();
		return true;
	}


	function updateTableVisuals() {
		// ... (rest of updateTableVisuals logic remains the same) ...
	}
	
	async function loadTables() {
		if (!URL_PARAMS.tenant_id) return false;

		let tables = [];
		
		// --- 1. Synchronously check if external config loaded (The final fix for table positions) ---
        // We use a small delay here to give the external script a millisecond to load the data globally.
        // NOTE: The syntax error means this initial check is the main problem.
        if (typeof window.CLIENT_TABLES !== 'undefined' && Array.isArray(window.CLIENT_TABLES) && window.CLIENT_TABLES.length > 0) {
             tables = window.CLIENT_TABLES;
             console.log(`Layout Loaded: Using configuration from ${URL_PARAMS.tenant_id}.js`);
        } else {
             console.error("CLIENT_TABLES not found or failed to load. Using fallback layout.");
             // CRITICAL FALLBACK: Use your old hardcoded layout if the client file fails.
             tables = [
                { id: 1, x: 235, y: 110, w: 90, h: 30, rotation: 0 },
                { id: 2, x: 100, y: 30, w: 90, h: 30, rotation: 0 },
                { id: 3, x: 100, y: 150, w: 30, h: 30, rotation: 0 },
                { id: 4, x: 140, y: 220, w: 30, h: 30, rotation: 0 },
                { id: 5, x: 180, y: 300, w: 50, h: 30, rotation: 90 },
                { id: 6, x: 250, y: 330, w: 30, h: 30, rotation: 0 },
                { id: 7, x: 30, y: 300, w: 50, h: 30, rotation: 90 },
                { id: 8, x: 400, y: 100, w: 30, h: 30, rotation: 0 },
                { id: 9, x: 20, y: 180, w: 30, h: 50, rotation: 0 },
                { id: 10, x: 300, y: 240, w: 30, h: 30, rotation: 0 },
                { id: 11, x: 40, y: 80, w: 30, h: 30, rotation: 0 },
                { id: 12, x: 350, y: 350, w: 50, h: 30, rotation: 0 },
                { id: 13, x: 400, y: 280, w: 30, h: 30, rotation: 0 },
                { id: 14, x: 250, y: 180, w: 30, h: 30, rotation: 0 },
                { id: 18, x: 140, y: 280, w: 30, h: 30, rotation: 0 },
                { id: 19, x: 220, y: 280, w: 30, h: 30, rotation: 0 },
                { id: 20, x: 300, y: 280, w: 30, h: 30, rotation: 0 },
                { id: 21, x: 300, y: 180, w: 50, h: 30, rotation: 90 }
            ];
        }
        
        tables.sort((a, b) => a.id - b.id);

		layer.destroyChildren();	
		tableDataMap = new Map();
		
		tables.forEach(t => {
			const price = getTablePrice(t.w, t.h);
			tableDataMap.set(t.id, { id: t.id, price: price, w: t.w, h: t.h });

			const group = drawTable(t);
			const tableRect = group.findOne('.main-table');
			
			group.offset({ x: tableRect.width()/2, y: tableRect.height()/2 });
			group.x(t.x + tableRect.width()/2);
			group.y(t.y + tableRect.height()/2);
			group.rotation(t.rotation || 0);	
		});
		
		layer.draw();	
	}
	
	function drawTable(t) {
		// ... (drawTable logic remains the same) ...
	}
	
	(async () => {
        // ... (initial setup remains the same) ...
		loadFloorplan(loadTables);
	})();
    
    // Final logic removed from here to prevent conflicts.

	</script>
</body>
</html>
